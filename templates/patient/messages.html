{% extends "base.html" %}

{% block title %}Patient Messages - Healthcare AI{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-envelope me-2"></i>My Messages</h2>
                <a href="{{ url_for('dashboard.new_message') }}" class="btn btn-primary" id="newMessageBtn">
                    <i class="fas fa-plus me-2"></i>New Message
                </a>
            </div>

            <!-- Messages Tabs -->
            <ul class="nav nav-tabs" id="messageTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="received-tab" data-bs-toggle="tab" data-bs-target="#received"
                        type="button" role="tab">
                        <i class="fas fa-inbox me-1"></i>Received
                        {% if received_messages %}
                        <span class="badge bg-primary ms-1">{{ received_messages|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button"
                        role="tab">
                        <i class="fas fa-paper-plane me-1"></i>Sent
                        {% if sent_messages %}
                        <span class="badge bg-secondary ms-1">{{ sent_messages|length }}</span>
                        {% endif %}
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="messageTabsContent">
                <!-- Received Messages -->
                <div class="tab-pane fade show active" id="received" role="tabpanel">
                    {% if received_messages %}
                    <div class="list-group mt-3">
                        {% for message in received_messages %}
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <i class="fas fa-user-md me-1 text-primary"></i>
                                    Dr. {{ message.sender.get_full_name() }}
                                </h6>
                                <small class="text-muted">{{ message.created_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                            </div>
                            <h6 class="mb-1">{{ message.subject }}</h6>
                            <p class="mb-1">{{ message.content[:100] }}{% if message.content|length > 100 %}...{% endif %}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    {% if not message.is_read %}
                                    <span class="badge bg-primary">New</span>
                                    {% else %}
                                    <span class="text-muted">Read</span>
                                    {% endif %}
                                </small>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('dashboard.view_message', message_id=message.id) }}"
                                        class="btn btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                    <button type="button" class="btn btn-outline-success"
                                        onclick="replyToMessage('{{ message.sender.id }}', '{{ message.subject }}')">
                                        <i class="fas fa-reply me-1"></i>Reply
                                    </button>
                                    <button type="button" class="btn btn-outline-info"
                                        onclick="startVideoCall('{{ message.sender.id }}')">
                                        <i class="fas fa-video me-1"></i>Video Call
                                    </button>
                                    <button type="button" class="btn btn-outline-warning"
                                        onclick="startAudioCall('{{ message.sender.id }}')">
                                        <i class="fas fa-phone me-1"></i>Audio Call
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Messages Received</h4>
                        <p class="text-muted">You haven't received any messages from doctors yet.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Sent Messages -->
                <div class="tab-pane fade" id="sent" role="tabpanel">
                    {% if sent_messages %}
                    <div class="list-group mt-3">
                        {% for message in sent_messages %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <i class="fas fa-user me-1 text-success"></i>
                                    To: Dr. {{ message.recipient.get_full_name() }}
                                </h6>
                                <small class="text-muted">{{ message.created_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                            </div>
                            <h6 class="mb-1">{{ message.subject }}</h6>
                            <p class="mb-1">{{ message.content[:100] }}{% if message.content|length > 100 %}...{% endif %}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <span class="badge bg-{{ 'success' if message.is_read else 'secondary' }}">
                                        {{ 'Read' if message.is_read else 'Unread' }}
                                    </span>
                                </small>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('dashboard.view_message', message_id=message.id) }}"
                                        class="btn btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                    <button type="button" class="btn btn-outline-info"
                                        onclick="startVideoCall('{{ message.recipient.id }}')">
                                        <i class="fas fa-video me-1"></i>Video Call
                                    </button>
                                    <button type="button" class="btn btn-outline-warning"
                                        onclick="startAudioCall('{{ message.recipient.id }}')">
                                        <i class="fas fa-phone me-1"></i>Audio Call
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-paper-plane fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Messages Sent</h4>
                        <p class="text-muted">You haven't sent any messages to doctors yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Video Call Modal -->
<div class="modal fade" id="videoCallModal" tabindex="-1" aria-labelledby="videoCallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoCallModalLabel">
                    <i class="fas fa-video me-2"></i>Video Call
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="localVideoContainer" class="video-container">
                            <video id="localVideo" autoplay muted class="w-100"></video>
                            <div class="video-overlay">
                                <span class="badge bg-primary">You</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div id="remoteVideoContainer" class="video-container">
                            <video id="remoteVideo" autoplay class="w-100"></video>
                            <div class="video-overlay">
                                <span class="badge bg-success" id="remoteUserName">Connecting...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="call-controls mt-3 text-center">
                    <button id="muteButton" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="videoButton" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-video"></i>
                    </button>
                    <button id="endCallButton" class="btn btn-danger">
                        <i class="fas fa-phone-slash"></i> End Call
                    </button>
                </div>
                <div id="callStatus" class="text-center mt-2">
                    <small class="text-muted">Initializing call...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audio Call Modal -->
<div class="modal fade" id="audioCallModal" tabindex="-1" aria-labelledby="audioCallModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="audioCallModalLabel">
                    <i class="fas fa-phone me-2"></i>Audio Call
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-user-circle fa-5x text-primary mb-3"></i>
                    <h4 id="audioCallUserName">Connecting...</h4>
                </div>
                <div class="call-controls">
                    <button id="audioMuteButton" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="endAudioCallButton" class="btn btn-danger">
                        <i class="fas fa-phone-slash"></i> End Call
                    </button>
                </div>
                <div id="audioCallStatus" class="mt-3">
                    <small class="text-muted">Initializing call...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newMessageModalLabel">
                    <i class="fas fa-envelope me-2"></i>New Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="newMessageForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="recipient" class="form-label">To:</label>
                        <select class="form-select" id="recipient" name="recipient_id" required>
                            <option value="">Select a doctor...</option>
                            <!-- Doctors will be loaded via JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="subject" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">Message:</label>
                        <textarea class="form-control" id="message" name="content" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Incoming Call Modal -->
<div class="modal fade" id="incomingCallModal" tabindex="-1" aria-labelledby="incomingCallModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incomingCallModalLabel">
                    <i class="fas fa-phone-volume me-2"></i>Incoming Call
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-user-circle fa-5x text-success mb-3"></i>
                    <h4 id="incomingCallerName">Unknown Caller</h4>
                    <p id="incomingCallType" class="text-muted">Video Call</p>
                </div>
                <div class="call-controls">
                    <button id="acceptCallButton" class="btn btn-success me-2">
                        <i class="fas fa-phone"></i> Accept
                    </button>
                    <button id="rejectCallButton" class="btn btn-danger">
                        <i class="fas fa-phone-slash"></i> Reject
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function replyToMessage(doctorId, subject) {
        // Pre-fill the new message modal with reply information
        document.getElementById('recipient').value = doctorId;
        document.getElementById('subject').value = 'Re: ' + subject;
        document.getElementById('message').focus();

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('newMessageModal'));
        modal.show();
    }

    // Load doctors for the recipient dropdown
    document.addEventListener('DOMContentLoaded', function () {
        loadDoctors();

        // Handle new message form submission
        const newMessageForm = document.getElementById('newMessageForm');
        if (newMessageForm) {
            newMessageForm.addEventListener('submit', function (e) {
                e.preventDefault();
                sendMessage();
            });
        }
    });

    async function loadDoctors() {
        try {
            const response = await fetch('/dashboard/api/doctors');
            const data = await response.json();

            const recipientSelect = document.getElementById('recipient');
            recipientSelect.innerHTML = '<option value="">Select a doctor...</option>';

            if (data.success && data.doctors) {
                data.doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = `Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization || 'General Practice'}`;
                    recipientSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading doctors:', error);
            // Fallback to sample data
            const recipientSelect = document.getElementById('recipient');
            recipientSelect.innerHTML = `
            <option value="">Select a doctor...</option>
            <option value="doctor1">Dr. John Smith - Cardiology</option>
            <option value="doctor2">Dr. Jane Doe - Neurology</option>
            <option value="doctor3">Dr. Mike Johnson - General Practice</option>
        `;
        }
    }

    async function sendMessage() {
        const formData = new FormData(document.getElementById('newMessageForm'));

        try {
            const response = await fetch('/dashboard/new_message', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Close modal and show success message
                const modal = bootstrap.Modal.getInstance(document.getElementById('newMessageModal'));
                modal.hide();

                // Reset form
                document.getElementById('newMessageForm').reset();

                // Show success message
                alert('Message sent successfully!');

                // Reload page to show new message
                location.reload();
            } else {
                alert('Error sending message: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error sending message. Please try again.');
        }
    }

    // Video/Audio Call functionality
    let currentCallId = null;
    let localStream = null;
    let peerConnection = null;
    let isAudioOnly = false;

    // WebRTC configuration
    const rtcConfiguration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };

    // Socket.IO connection
    const socket = io();

    // Socket event listeners
    socket.on('offer', handleOffer);
    socket.on('answer', handleAnswer);
    socket.on('ice_candidate', handleIceCandidate);
    socket.on('call_connected', handleCallConnected);
    socket.on('call_rejected', handleCallRejected);
    socket.on('user_joined', handleUserJoined);
    socket.on('user_left', handleUserLeft);

    function startVideoCall(recipientId) {
        isAudioOnly = false;
        startCall(recipientId, 'video');
    }

    function startAudioCall(recipientId) {
        isAudioOnly = true;
        startCall(recipientId, 'audio');
    }

    async function startCall(recipientId, callType) {
        try {
            // Request user media
            const constraints = {
                audio: true,
                video: !isAudioOnly
            };

            localStream = await navigator.mediaDevices.getUserMedia(constraints);

            // Show appropriate modal
            if (isAudioOnly) {
                const modal = new bootstrap.Modal(document.getElementById('audioCallModal'));
                modal.show();
                document.getElementById('audioCallUserName').textContent = 'Calling...';
                document.getElementById('audioCallStatus').innerHTML = '<small class="text-muted">Calling...</small>';
            } else {
                const modal = new bootstrap.Modal(document.getElementById('videoCallModal'));
                modal.show();
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('remoteUserName').textContent = 'Calling...';
                document.getElementById('callStatus').innerHTML = '<small class="text-muted">Calling...</small>';
            }

            // Start call via API
            const response = await fetch('/dashboard/calls/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recipient_id: recipientId,
                    call_type: callType
                })
            });

            const data = await response.json();
            if (data.success) {
                currentCallId = data.call_id;
                socket.emit('join_call', { call_id: currentCallId, user_id: '{{ current_user.id }}' });

                // Initialize peer connection
                initializePeerConnection();

                if (isAudioOnly) {
                    document.getElementById('audioCallStatus').innerHTML = '<small class="text-muted">Ringing...</small>';
                } else {
                    document.getElementById('callStatus').innerHTML = '<small class="text-muted">Ringing...</small>';
                }
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            console.error('Error starting call:', error);
            alert('Failed to start call: ' + error.message);
            cleanupCall();
        }
    }

    function initializePeerConnection() {
        peerConnection = new RTCPeerConnection(rtcConfiguration);

        // Add local stream tracks
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        // Handle remote stream
        peerConnection.ontrack = (event) => {
            if (isAudioOnly) {
                // For audio calls, we don't show video elements
                console.log('Audio stream received');
            } else {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            }
        };

        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('ice_candidate', {
                    call_id: currentCallId,
                    candidate: event.candidate
                });
            }
        };

        // Handle connection state changes
        peerConnection.onconnectionstatechange = () => {
            console.log('Connection state:', peerConnection.connectionState);
            if (peerConnection.connectionState === 'connected') {
                if (isAudioOnly) {
                    document.getElementById('audioCallStatus').innerHTML = '<small class="text-success">Connected</small>';
                } else {
                    document.getElementById('callStatus').innerHTML = '<small class="text-success">Connected</small>';
                }
            }
        };
    }

    async function handleOffer(data) {
        try {
            if (!peerConnection) {
                // Incoming call - show incoming call modal
                showIncomingCallModal(data.call_type || 'video');
                return;
            }

            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            socket.emit('answer', {
                call_id: currentCallId,
                answer: answer
            });
        } catch (error) {
            console.error('Error handling offer:', error);
        }
    }

    async function handleAnswer(data) {
        try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } catch (error) {
            console.error('Error handling answer:', error);
        }
    }

    async function handleIceCandidate(data) {
        try {
            if (data.candidate) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        } catch (error) {
            console.error('Error handling ICE candidate:', error);
        }
    }

    function handleCallConnected(data) {
        if (isAudioOnly) {
            document.getElementById('audioCallStatus').innerHTML = '<small class="text-success">Connected</small>';
        } else {
            document.getElementById('callStatus').innerHTML = '<small class="text-success">Connected</small>';
        }
    }

    function handleCallRejected(data) {
        alert('Call was rejected');
        cleanupCall();
    }

    function handleUserJoined(data) {
        console.log('User joined:', data.user_name);
        if (isAudioOnly) {
            document.getElementById('audioCallUserName').textContent = data.user_name;
        } else {
            document.getElementById('remoteUserName').textContent = data.user_name;
        }
    }

    function handleUserLeft(data) {
        console.log('User left:', data.user_id);
        cleanupCall();
    }

    function showIncomingCallModal(callType) {
        isAudioOnly = (callType === 'audio');
        document.getElementById('incomingCallType').textContent = callType.charAt(0).toUpperCase() + callType.slice(1) + ' Call';

        const modal = new bootstrap.Modal(document.getElementById('incomingCallModal'));
        modal.show();
    }

    async function acceptCall() {
        try {
            // Get user media for incoming call
            const constraints = {
                audio: true,
                video: !isAudioOnly
            };

            localStream = await navigator.mediaDevices.getUserMedia(constraints);

            // Close incoming call modal and open appropriate call modal
            const incomingModal = bootstrap.Modal.getInstance(document.getElementById('incomingCallModal'));
            incomingModal.hide();

            if (isAudioOnly) {
                const modal = new bootstrap.Modal(document.getElementById('audioCallModal'));
                modal.show();
            } else {
                const modal = new bootstrap.Modal(document.getElementById('videoCallModal'));
                modal.show();
                document.getElementById('localVideo').srcObject = localStream;
            }

            // Initialize peer connection and accept call
            initializePeerConnection();
            socket.emit('call_accepted', { call_id: currentCallId });

        } catch (error) {
            console.error('Error accepting call:', error);
            rejectCall();
        }
    }

    function rejectCall() {
        socket.emit('call_rejected', { call_id: currentCallId });
        const modal = bootstrap.Modal.getInstance(document.getElementById('incomingCallModal'));
        modal.hide();
        cleanupCall();
    }

    function endCall() {
        fetch(`/dashboard/calls/end/${currentCallId}`, {
            method: 'POST'
        }).then(() => {
            cleanupCall();
        });
    }

    function cleanupCall() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }

        currentCallId = null;

        // Close modals
        const videoModal = bootstrap.Modal.getInstance(document.getElementById('videoCallModal'));
        if (videoModal) videoModal.hide();

        const audioModal = bootstrap.Modal.getInstance(document.getElementById('audioCallModal'));
        if (audioModal) audioModal.hide();
    }

    // Event listeners for call controls
    document.getElementById('muteButton').addEventListener('click', function () {
        const audioTracks = localStream.getAudioTracks();
        audioTracks.forEach(track => {
            track.enabled = !track.enabled;
            this.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            this.classList.toggle('btn-outline-secondary');
            this.classList.toggle('btn-warning');
        });
    });

    document.getElementById('videoButton').addEventListener('click', function () {
        const videoTracks = localStream.getVideoTracks();
        videoTracks.forEach(track => {
            track.enabled = !track.enabled;
            this.innerHTML = track.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            this.classList.toggle('btn-outline-secondary');
            this.classList.toggle('btn-warning');
        });
    });

    document.getElementById('endCallButton').addEventListener('click', endCall);
    document.getElementById('endAudioCallButton').addEventListener('click', endCall);
    document.getElementById('acceptCallButton').addEventListener('click', acceptCall);
    document.getElementById('rejectCallButton').addEventListener('click', rejectCall);

    document.getElementById('audioMuteButton').addEventListener('click', function () {
        const audioTracks = localStream.getAudioTracks();
        audioTracks.forEach(track => {
            track.enabled = !track.enabled;
            this.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            this.classList.toggle('btn-outline-secondary');
            this.classList.toggle('btn-warning');
        });
    });
</script>

<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .video-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }

    #localVideo,
    #remoteVideo {
        width: 100%;
        height: auto;
        object-fit: cover;
    }

    .call-controls .btn {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}
