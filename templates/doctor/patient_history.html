{% extends "base.html" %}

{% block title %}Patient History - Healthcare AI{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-history me-2"></i>Patient Medical History</h2>
                    <p class="text-muted mb-0">Complete medical history for {{ patient.get_full_name() }}</p>
                </div>
                <a href="{{ url_for('dashboard.doctor_patients') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Patients
                </a>
            </div>

            <!-- Patient Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Patient Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> {{ patient.get_full_name() }}</p>
                            <p><strong>Email:</strong> {{ patient.email }}</p>
                            <p><strong>Phone:</strong> {{ patient.phone or 'Not provided' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Date of Birth:</strong> {{ patient.date_of_birth.strftime('%B %d, %Y') if patient.date_of_birth else 'Not provided' }}</p>
                            <p><strong>Blood Group:</strong> {{ patient.blood_group or 'Not provided' }}</p>
                            <p><strong>Medical History:</strong> {{ patient.medical_history or 'Not provided' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Appointments -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>Completed Appointments
                    </h5>
                </div>
                <div class="card-body">
                    {% if appointments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Doctor</th>
                                        <th>Symptoms</th>
                                        <th>Diagnosis</th>
                                        <th>Treatment</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in appointments %}
                                    <tr>
                                        <td>{{ appointment.appointment_date.strftime('%B %d, %Y') }}</td>
                                        <td>{{ appointment.appointment_date.strftime('%I:%M %p') }}</td>
                                        <td>Dr. {{ appointment.doctor.get_full_name() }}</td>
                                        <td>{{ appointment.symptoms or 'Not specified' }}</td>
                                        <td>{{ appointment.diagnosis or 'Not specified' }}</td>
                                        <td>{{ appointment.treatment_plan or 'Not specified' }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if appointment.status.value == 'completed' else 'warning' }}">
                                                {{ appointment.status.value.title() }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No completed appointments found for this patient.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Medical Reports -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-medical me-2"></i>Medical Reports
                    </h5>
                </div>
                <div class="card-body">
                    {% if reports %}
                        <div class="row">
                            {% for report in reports %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-left-primary">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ report.title }}</h6>
                                        <p class="card-text small text-muted">
                                            <strong>Type:</strong> {{ report.report_type.value.replace('_', ' ').title() }}<br>
                                            <strong>Date:</strong> {{ report.created_at.strftime('%B %d, %Y') }}<br>
                                            <strong>Created by:</strong> {{ report.created_by.get_full_name() }}
                                        </p>
                                        {% if report.description %}
                                            <p class="card-text small">{{ report.description[:100] }}{% if report.description|length > 100 %}...{% endif %}</p>
                                        {% endif %}
                                        <a href="{{ url_for('dashboard.view_report', report_id=report.id) }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i>View Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-file-medical fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No medical reports found for this patient.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Prescriptions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-pills me-2"></i>Prescriptions
                    </h5>
                </div>
                <div class="card-body">
                    {% if prescriptions %}
                        <div class="row">
                            {% for prescription in prescriptions %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-left-success">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-prescription-bottle me-1"></i>
                                            Prescription #{{ (prescription.id|string)[:8] }}
                                        </h6>
                                        <p class="card-text small text-muted">
                                            <strong>Doctor:</strong> Dr. {{ prescription.doctor.get_full_name() }}<br>
                                            <strong>Date:</strong> {{ prescription.created_at.strftime('%B %d, %Y') }}<br>
                                            <strong>Duration:</strong> {{ prescription.duration }}
                                        </p>
                                        {% if prescription.notes %}
                                            <p class="card-text small">{{ prescription.notes[:100] }}{% if prescription.notes|length > 100 %}...{% endif %}</p>
                                        {% endif %}
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="viewPrescription('{{ prescription.id|to_string }}')">
                                                <i class="fas fa-eye me-1"></i>View Details
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="printPrescription('{{ prescription.id|to_string }}')">
                                                <i class="fas fa-print me-1"></i>Print
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-pills fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No prescriptions found for this patient.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function viewPrescription(prescriptionId) {
    // This would open a modal or redirect to view prescription details
    alert('View prescription details for ID: ' + prescriptionId);
}

function printPrescription(prescriptionId) {
    // This would open print dialog for the prescription
    alert('Print prescription for ID: ' + prescriptionId);
}
</script>
{% endblock %}
